<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#219ebc">
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    background: #f4f9f9;
    color: #333;
    margin: 0;
    padding: 0;
  }
  #circle {
    width: 150px;
    height: 150px;
    margin: 40px auto;
    border-radius: 50%;
    /* On ne met pas ici de transition globale : on l'ajoute dynamiquement selon la phase */
    transform: scale(1); /* Ã©tat initial */
    background-color: #8ecae6;
  }
  .controls, .custom-controls {
    margin-top: 20px;
  }
  button {
    margin: 5px;
    padding: 10px 20px;
    font-size: 1rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    background-color: #219ebc;
    color: white;
  }
  button:hover {
    background-color: #126782;
  }
  .custom-controls input {
    width: 60px;
    padding: 5px;
    margin: 5px;
    text-align: center;
  }
</style>
</head>
<body>

<p id="global-timer">Temps total: 0 min 0 sec</p>
<p id="mode-label">Mode : Standard 5-0-5-0</p>
<div id="circle"></div>
<p id="instruction">Inspire...</p>
<p id="timer"> </p>

<!-- Boutons principaux -->
<button id="startButton">DÃ©marrer la respiration</button>
<button id="muteButton">ðŸ”‡ Son coupÃ©</button>

<div class="controls">
  <button onclick="startBreathing(5,0,5,0,'5-0-5-0')">5</button>
  <button onclick="startBreathing(6,0,6,0,'6-0-6-0')">6</button>
  <button onclick="startBreathing(7,0,7,0,'7-0-7-0')">7</button>
  <button onclick="startBreathing(8,0,8,0,'8-0-8-0')">8</button>
  <button onclick="startBreathing(9,0,9,0,'9-0-9-0')">9</button>
  <button onclick="startBreathing(10,0,10,0,'10-0-10-0')">10</button>
  <button onclick="startBreathing(11,0,11,0,'11-0-11-0')">11</button>
</div>

<div class="custom-controls">
  <label for="inhaleTime">Inspiration (sec):</label>
  <input type="number" id="inhaleTime" value="5">
  <label for="pause1Time">ArrÃªt 1 (sec):</label>
  <input type="number" id="pause1Time" value="0">
  <label for="exhaleTime">Expiration (sec):</label>
  <input type="number" id="exhaleTime" value="5">
  <label for="pause2Time">ArrÃªt 2 (sec):</label>
  <input type="number" id="pause2Time" value="0">
  <button onclick="startCustomBreathing()">PersonnalisÃ©</button>
</div>

<script>
/* Ã©lÃ©ments DOM */
let circle = document.getElementById('circle');
let instruction = document.getElementById('instruction');
let modeLabel = document.getElementById('mode-label');
let timerDisplay = document.getElementById('timer');
let globalTimerDisplay = document.getElementById('global-timer');

let interval;
let globalTimerInterval;
let totalTime = 0;
let isMuted = true; // ðŸ”‡ par dÃ©faut

/* sons (optionnels) */
let inhaleSound = new Audio('inhale.mp3');
let exhaleSound = new Audio('exhale.mp3');
let pauseSound = new Audio('pause.mp3');

function playSound(phase) {
  if (isMuted) return;
  try {
    if (phase === 'inhale') {
      inhaleSound.currentTime = 0; inhaleSound.play();
    } else if (phase === 'exhale') {
      exhaleSound.currentTime = 0; exhaleSound.play();
    } else {
      pauseSound.currentTime = 0; pauseSound.play();
    }
  } catch (e) {
    // ignore play errors
    console.warn('Impossible de jouer le son:', e);
  }
}

/* toggle du son */
document.getElementById('muteButton').addEventListener('click', () => {
  isMuted = !isMuted;
  document.getElementById('muteButton').textContent = isMuted ? 'ðŸ”‡ Son coupÃ©' : 'ðŸ”Š Son activÃ©';
});

/* constantes d'Ã©chelle */
const SCALE_INHALE = 1.4; // grossit
const SCALE_EXHALE = 0.6; // rÃ©duit

/**
 * anime le cercle suivant la phase.
 * - phase: 'inhale' | 'exhale' | 'pause'
 * - duration: durÃ©e en secondes utilisÃ©e pour la transition (pour inhale/exhale)
 *
 * Comportement demandÃ© :
 * - inspire : cercle grossit -> vert
 * - expire  : cercle rÃ©duit -> bleu
 * - arrÃªt   : conserve la derniÃ¨re taille -> gris (pas de modification de transform)
 */
function animateForPhase(phase, duration) {
  if (phase === 'inhale') {
    // transition pour monter
    circle.style.transition = `transform ${duration}s ease-in-out`;
    circle.style.transform = `scale(${SCALE_INHALE})`;
    circle.style.backgroundColor = '#b3e2cd'; // vert pastel
  } else if (phase === 'exhale') {
    // transition pour descendre
    circle.style.transition = `transform ${duration}s ease-in-out`;
    circle.style.transform = `scale(${SCALE_EXHALE})`;
    circle.style.backgroundColor = '#8ecae6'; // bleu pastel
  } else { // pause
    // ne change pas la taille (conserve la derniÃ¨re transform)
    // on enlÃ¨ve la transition pour Ã©viter toute animation involontaire pendant la pause
    circle.style.transition = `none`;
    circle.style.backgroundColor = 'gray';
    // transform laissÃ© tel quel (conserve derniÃ¨re valeur)
  }
}

/* fonction principale */
function startBreathing(inhale, pause1, exhale, pause2, label) {
  clearInterval(interval);
  clearInterval(globalTimerInterval);
  totalTime = 0;
  modeLabel.textContent = "Mode : " + label;

  let phase = 'inhale';
  instruction.textContent = 'Inspire...';
  // initialise la taille et la couleur en fonction de l'inhale
  animateForPhase('inhale', inhale);
  updateTimer(phase, inhale, 0);
  playSound(phase);
  updateGlobalTimer();

  let count = 0;

  globalTimerInterval = setInterval(() => {
    totalTime++;
    updateGlobalTimer();
  }, 1000);

  interval = setInterval(() => {
    count++;
    // INHALE
    if (phase === 'inhale') {
      if (count >= inhale) {
        count = 0;
        if (pause1 > 0) {
          phase = 'pause1';
          instruction.textContent = 'ArrÃªt...';
          // pause : ne modifie pas la taille, mais change couleur en gris
          animateForPhase('pause', pause1);
          updateTimer(phase, pause1, 0);
          playSound('pause');
        } else {
          phase = 'exhale';
          instruction.textContent = 'Expire...';
          animateForPhase('exhale', exhale);
          updateTimer(phase, exhale, 0);
          playSound('exhale');
        }
      } else {
        updateTimer(phase, inhale, count);
      }

    // PAUSE1
    } else if (phase === 'pause1') {
      if (count >= pause1) {
        count = 0;
        phase = 'exhale';
        instruction.textContent = 'Expire...';
        animateForPhase('exhale', exhale);
        updateTimer(phase, exhale, 0);
        playSound('exhale');
      } else {
        updateTimer(phase, pause1, count);
      }

    // EXHALE
    } else if (phase === 'exhale') {
      if (count >= exhale) {
        count = 0;
        if (pause2 > 0) {
          phase = 'pause2';
          instruction.textContent = 'ArrÃªt...';
          animateForPhase('pause', pause2);
          updateTimer(phase, pause2, 0);
          playSound('pause');
        } else {
          phase = 'inhale';
          instruction.textContent = 'Inspire...';
          animateForPhase('inhale', inhale);
          updateTimer(phase, inhale, 0);
          playSound('inhale');
        }
      } else {
        updateTimer(phase, exhale, count);
      }

    // PAUSE2
    } else if (phase === 'pause2') {
      if (count >= pause2) {
        count = 0;
        phase = 'inhale';
        instruction.textContent = 'Inspire...';
        animateForPhase('inhale', inhale);
        updateTimer(phase, inhale, 0);
        playSound('inhale');
      } else {
        updateTimer(phase, pause2, count);
      }
    }
  }, 1000);
}

/* utilitaires */
function startCustomBreathing() {
  let inhaleTime = parseInt(document.getElementById('inhaleTime').value);
  let pause1Time = parseInt(document.getElementById('pause1Time').value);
  let exhaleTime = parseInt(document.getElementById('exhaleTime').value);
  let pause2Time = parseInt(document.getElementById('pause2Time').value);

  if (isNaN(inhaleTime) || isNaN(exhaleTime) || isNaN(pause1Time) || isNaN(pause2Time) ||
      inhaleTime < 0 || exhaleTime < 0 || pause1Time < 0 || pause2Time < 0) {
    alert("Veuillez entrer des valeurs valides.");
    return;
  }
  startBreathing(inhaleTime, pause1Time, exhaleTime, pause2Time,
                 `PersonnalisÃ© ${inhaleTime}-${pause1Time}-${exhaleTime}-${pause2Time}`);
}

function updateTimer(phase, duration, count) {
  timerDisplay.textContent = `${phase}... ${count + 1}/${duration}`;
}

function updateGlobalTimer() {
  let minutes = Math.floor(totalTime / 60);
  let seconds = totalTime % 60;
  globalTimerDisplay.textContent = `Temps total: ${minutes} min ${seconds} sec`;
}

/* Wake Lock (inchangÃ©) */
let wakeLock = null;
async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
    }
  } catch (err) {
    console.error(err);
  }
}
document.addEventListener('visibilitychange', () => {
  if (wakeLock !== null && document.visibilityState === 'visible') {
    requestWakeLock();
  }
});
requestWakeLock();

/* service worker (inchangÃ©) */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js').then(() => {
    console.log('Service Worker enregistrÃ©');
  });
}

/* dÃ©marrage aprÃ¨s clic (permet autorisation son) */
document.getElementById('startButton').addEventListener('click', () => {
  startBreathing(5, 0, 5, 0, '5-0-5-0');
  document.getElementById('startButton').disabled = true;
});
</script>
</body>
</html>
